// pipeline {
//     agent any

//     environment {
//         COMPOSE_FILE = 'compose.yml'
//     }


//     stages {
//         stage('Checkout') {
//             steps {
//                 git branch: 'main', url: 'https://github.com/Tawunchai/serverless-cloud.git'
//             }
//         }

//         stage('Stop Old Containers?') {
//             steps {
//                 sh 'docker-compose -f ${COMPOSE_FILE} down || true'
//             }
//         }

//         stage('Build & Start Containers.') {
//             steps {
//                 sh 'docker-compose -f ${COMPOSE_FILE} build'
//                 sh 'docker-compose -f ${COMPOSE_FILE} up -d'
//             }
//         }
//     }
// }
pipeline {
  agent any

  environment {
    COMPOSE_FILE = 'compose.yml'
    TARGET_SERVICES = 'frontend note-service social-service auth-service notification-service api-gateway reverse-proxy'
  }

  stages {
    stage('======= Checkout Code =======') {
      steps {
        echo 'üßæ Checking out repository...'
        checkout scm
      }
    }

    stage('======= Checkout External Repo (Optional) =======') {
      steps {
        echo 'üîÑ Cloning external repo (optional)...'
        git branch: 'main', url: 'https://github.com/Tawunchai/serverless-cloud.git'
      }
    }

    stage('======= Clean up Old Containers =======') {
      steps {
        echo 'üßπ Cleaning up Docker containers and images...'
        sh "docker-compose -f $COMPOSE_FILE down -v || true"
        sh "docker system prune -a -f || true"
      }
    }

    stage('======= Build and Start Containers =======') {
      steps {
        echo 'üöÄ Building and starting services...'
        sh "docker-compose -f $COMPOSE_FILE build $TARGET_SERVICES"
        sh "docker-compose -f $COMPOSE_FILE up -d $TARGET_SERVICES"
      }
    }

    stage('======= Debug Container Status =======') {
      steps {
        echo 'üîç Showing container status and logs...'
        sh 'docker ps -a'
        sh 'docker logs frontend || true'
        sh 'docker logs note-service || true'
        sh 'docker logs reverse-proxy || true'
        sh 'docker inspect frontend || true'
      }
    }
  }

  post {
    success {
      echo '‚úÖ Deployment successful!'
    }
    failure {
      echo '‚ùå Deployment failed!'
    }
    always {
      echo 'üßº Post-build cleanup: removing dangling images...'
      sh 'docker image prune -f --filter "dangling=true" || true'
    }
  }
}
